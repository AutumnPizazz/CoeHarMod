# Unciv 比赛裁判工具

## 项目概述

Unciv 比赛裁判工具是一个用于从 Unciv 多人游戏服务器提取游戏数据并计算比赛得分的工具。支持从服务器获取游戏存档，提取各文明的统计数据，并根据可配置的评分规则计算比赛得分。

## 技术栈

- **语言**: Python 3.14+
- **核心库**:
  - `requests` - HTTP 客户端，用于与 Unciv 服务器通信
  - `json` - JSON 数据解析
  - `csv` - CSV 文件导出
- **打包工具**: PyInstaller 6.18.0

## 项目结构

```
Unciv比赛裁判工具/
├── Unciv联机游戏数据提取.py  # 主程序
├── build_exe.ps1              # PowerShell 打包脚本
├── UncivRefereeTool.spec      # PyInstaller 配置文件
├── unciv_config.json          # 配置文件（首次运行自动生成）
├── 使用说明.txt               # 使用说明（首次运行自动生成）
├── build/                     # 构建临时文件
└── dist/                      # 打包输出目录
    └── UncivRefereeTool.exe   # 可执行文件
```

## 核心功能

### 1. API 客户端 (UncivAPIClient)

通过 Unciv V1 API 与服务器通信：

- `is_alive()` - 检查服务器是否在线
- `login(username, password)` - 使用 Basic Auth 登录
- `list_files()` - 获取服务器上的文件列表
- `get_file(file_name)` - 获取指定文件内容

### 2. 数据提取器 (VictoryDataExtractor)

从游戏数据中提取胜利面板相关信息：

- `load_from_api()` - 从 API 加载游戏数据
- `get_victory_data()` - 提取胜利面板数据
- `_get_basic_stats()` - 获取基础统计数据（人口、现金、回合金等）
- `_calculate_score_breakdown()` - 计算文明积分明细
- `_calculate_match_score()` - 计算比赛得分

### 3. 配置管理 (ConfigManager)

管理配置文件的加载和保存：

- `load_config()` - 加载配置文件
- `save_config()` - 保存配置文件
- `ensure_files_exist()` - 确保配置文件和说明文件存在

### 4. 得分配置 (ScoreConfig)

管理比赛得分的评分规则：

- `load_from_file()` - 从配置文件加载得分规则
- `save_to_file()` - 保存得分规则到配置文件

## 数据格式

### statsHistory 格式

Unciv 使用 `CivRankingHistory` 存储历史统计数据：

**新格式**（字符串压缩格式）：
```json
{
  "0": "S50N10C2P6G26T7F1352H3W2A3",
  "1": "S55N12C3P8G30T10F1500H5W4A5"
}
```

**旧格式**（对象格式）：
```json
{
  "0": {"S": 50, "N": 10, "C": 2, "P": 6, "G": 26, "T": 7, "F": 1352, "H": 3, "W": 2, "A": 3}
}
```

**统计类型说明**（来自 `RankingType.kt`）：

| 字符 | 含义 | 英文 |
|------|------|------|
| S | 文明积分 | Score |
| N | 人口 | Population |
| C | 成长 | Growth |
| P | 产能 | Production |
| G | 现金 | Gold |
| T | 领土 | Territory |
| F | 军事实力 | Force |
| H | 幸福度 | Happiness |
| W | 科技 | Technologies |
| A | 文化 | Culture |

### 重要注意事项

- `statsHistory` 的键在 JSON 中是**字符串类型**（`"0"`, `"1"`, `"10"`），需要转换为整数后比较以获取最新回合
- 字符串比较会导致 `"100"` < `"20"`（因为字符'1' < '2'），必须转换为整数比较

## 比赛得分计算

### 得分公式

```text
得分 = 基础分 + 存活奖励/击败惩罚 + 综合实力分 + 发展指标分 + 经济健康分 + 幸福度 + 文明进步分
```

### 各维度详情

#### 基础配置

- **基础分**: 所有文明起始得分（默认 100）
- **存活奖励**: 存活文明的额外加分（默认 30）
- **击败惩罚**: 被击败文明的扣分（默认 -30）

#### 综合实力分（上限 ±20 分）

- **文明积分**: 每 5 文明积分差距 ±1 分
- **军事实力**: 每 50 军事实力差距 ±1 分
- **科技领先**: 每 2 科技差距 ±1 分

#### 发展指标分（上限 ±15 分）

- **人口**: 每 3 人口差距 ±1 分
- **城市数**: 每 1 城市差距 ±2 分
- **领土**: 每 10 领土差距 ±1 分

#### 经济健康分（上限 ±10 分）

- **现金**: 每 50 现金差距 ±1 分
- **回合金**: 每 5 回合金差距 ±1 分

#### 文明进步分（上限 ±10 分）

- **已采纳政策**: 每 1 政策差距 ±2 分

#### 幸福度（无上限）

- 以 0 为基准，每正/负 1 幸福度得 ±1 分

### 计算原则

- 每个文明的通过与所有其他玩家的**平均值**对比来计算
- 各维度有**上限设置**，避免优势无限放大
- **城邦**（City-State）不参与得分计算
- **看海玩家**（0 城市）不参与得分计算

## 配置文件

### unciv_config.json

```json
{
  "服务器": "http://sp.unciv.cn:30123",
  "用户名": "",
  "密码": "",
  "游戏ID": "",
  "输出文件": "victory_data.csv",
  "score_config": {
    "基础分": 100,
    "存活奖励": 30,
    "击败惩罚": -30,
    "综合实力分": {
      "上限": 20,
      "文明积分": {"分母": 5, "分子": 1},
      "军事实力": {"分母": 50, "分子": 1},
      "科技领先": {"分母": 2, "分子": 1}
    },
    "发展指标分": {
      "上限": 15,
      "人口": {"分母": 3, "分子": 1},
      "城市数": {"分母": 1, "分子": 2},
      "领土": {"分母": 10, "分子": 1}
    },
    "经济健康分": {
      "上限": 10,
      "现金": {"分母": 50, "分子": 1},
      "回合金": {"分母": 5, "分子": 1}
    },
    "文明进步分": {
      "上限": 10,
      "已采纳政策": {"分母": 1, "分子": 2}
    }
  }
}
```

## 构建和打包

### 环境要求

- Python 3.14 或更高版本
- PyInstaller

### 构建步骤

#### Windows

```powershell
# 使用 PowerShell 运行打包脚本
cd Unciv比赛裁判工具
powershell.exe -ExecutionPolicy Bypass -File build_exe.ps1
```

#### 手动打包

```bash
# 安装 PyInstaller
pip install pyinstaller

# 打包为单文件 EXE
pyinstaller --onefile --name "UncivRefereeTool" --clean --noconfirm "Unciv联机游戏数据提取.py"
```

### 输出文件

打包完成后，可执行文件位于 `dist/UncivRefereeTool.exe`。

## 使用说明

1. 将 `UncivRefereeTool.exe` 复制到任意位置
2. 首次运行会自动生成 `unciv_config.json` 配置文件
3. 编辑配置文件，填写服务器地址、用户名、密码、游戏ID等信息
4. 再次运行程序，根据提示操作
5. 程序会显示数据摘要和比赛得分表格
6. 选择是否导出为 CSV 文件

## 输出格式

### CSV 文件字段

| 字段名 | 说明 |
|--------|------|
| 文明ID | 文明唯一标识符 |
| 文明名称 | 文明显示名称 |
| 状态 | 存活/已击败 |
| 玩家类型 | 人类/AI |
| 是否城邦 | 布尔值 |
| 人口 | 文明总人口 |
| 现金 | 当前现金储备 |
| 回合金 | 每回合净收入 |
| 幸福度 | 文明幸福度 |
| 军事实力 | 军事力量数值 |
| 产能 | 生产能力 |
| 城市数 | 拥有的城市数量 |
| 已研究科技数 | 研究完成的科技数量 |
| 已采纳的政策数 | 采纳的社会政策数量 |
| 总文明积分 | 文明总积分 |
| 分数 | 文明积分 |
| 城市分数 | 城市贡献的积分 |
| 人口分数 | 人口贡献的积分 |
| 地块分数 | 领土贡献的积分 |
| 奇观分数 | 世界奇观贡献的积分 |
| 科技分数 | 科技贡献的积分 |
| 未来科技分数 | 未来科技贡献的积分 |
| 比赛得分 | 根据评分规则计算的比赛得分 |
| 世界奇观 | 拥有的世界奇观数量 |
| 自然奇观 | 发现的自然奇观数量 |
| 伟人诞生 | 诞生的伟人数量 |

## 开发注意事项

### 数据提取关键点

1. **回合键类型转换**: `statsHistory` 的键是字符串类型，必须转换为整数后比较

2. **新旧格式兼容**: 需要同时处理字符串格式和对象格式的 `statsHistory`

3. **城邦和看海玩家**: 这些特殊玩家类型不应参与得分计算

4. **地图大小修正**: 文明积分计算需要根据地图大小进行修正

### 序列化问题

- 游戏数据可能是 Base64 编码和 Gzip 压缩的，需要正确解码
- 部分字段可能不存在，需要提供合理的默认值

## 相关资源

- Unciv 官方文档: https://yairm210.github.io/Unciv/
- Unciv GitHub: https://github.com/yairm210/Unciv
- PyInstaller 文档: https://pyinstaller.org/