!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).MiniSearch=t()}(this,(function(){"use strict";var e=function(){return(e=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var r=arguments[t];for(var n in r)Object.prototype.hasOwnProperty.call(r,n)&&(e[n]=r[n])}return e}).apply(this,arguments)};function t(e,t){void 0===t&&(t={});var r=t.fields||Object.keys(e),n=t.idField||"id",i=t.extractField||function(t,r){return function(e,t){for(var r=e.split("."),n=0;n<r.length;n++){var i=r[n];if(null==t)return void 0;t=t[i]}return t}(t,r)},o={};o[n]=e[n];for(var a=0;a<r.length;a++){var s=r[a],u=i(e,s);null!=u&&(o[s]=u)}return o}function r(e){return e.replace(/[^a-zA-Z0-9\u00C0-\u024F\u1E00-\u1EFF]/g," ").toLowerCase().trim().split(/\s+/).filter(Boolean)}function n(e){return Array.isArray(e)?e:[e]}function i(e,t){var r=n(e);return t?t(r):r}function o(e,t){var r=t.tokenize,n=t.processTerm,o=t.fields,a=t.searchOptions,s=void 0===a?{}:a,u=s.prefix,c=void 0===u?!1:u,l=s.fuzzy,f=void 0===l?!1:l,d=s.combine,h=void 0===d?"AND":d,p=s.boost,g=void 0===p?{}:p,v=s.weights,y=void 0===v?{}:v,b=[],m=[];return Object.keys(e).forEach((function(d){var v=e[d],y=o.includes(d)?v:"",b=r(y,!0),m=[];if(b.forEach((function(e){var r=n(e);r&&m.push({term:r,prefix:!1}),c&&m.push({term:r,prefix:!0})})),f)for(var v=0;v<b.length;v++){var y=b[v],w=n(y);w&&m.push({term:w,prefix:!1,fuzzy:!0})}m.length&&b.push({field:d,terms:m})})),{queries:b,combine:h,boost:g,weights:y}}function a(e,t){var r=t.fields,n=t.storeFields,i=t.searchOptions,o=void 0===i?{}:i,a=o.combine,s=void 0===a?"AND":a,u=o.boost,c=void 0===u?{}:u,l=o.weights,f=void 0===l?{}:l,d=[],h=[];return r.forEach((function(r){var n=e[r]||[],i=n.map((function(e){return{field:r,terms:e.terms}}));d=d.concat(i)})),h=n?n.map((function(t){return e[t]})):{},{queries:d,combine:s,boost:c,weights:f,store:h}}var s=function(){function t(t){var r=this;if(void 0===t&&(t={}),this._options=e({extractField:function(e,t){return e[t]},tokenize:r,processTerm:function(e){return e.toLowerCase()},fields:[],searchOptions:{},storeFields:[],logger:function(e){return console.warn(e)}},t),this._index={},this._documentCount={},this._fields=this._options.fields,this._storeFields=this._options.storeFields,this._logger=this._options.logger,this._options.idField||this._logger("WARNING: no idField specified, using the document index as id"),this._idField=this._options.idField||"id",this._documentIds=[],this._documentCount={},this._avgFieldLength={},this._fieldLengths={},this._options.fields.length||this._logger("WARNING: no fields specified"),this._options.fields.forEach((function(e){r._documentCount[e]=0,r._avgFieldLength[e]=0,r._fieldLengths[e]={}})),this.addFields(this._options.fields),this._options.storeFields.forEach((function(e){r._fieldLengths[e]={}})),this._options.autoSuggest?this._logger("WARNING: autoSuggest option is deprecated. Use suggest instead"):null,this._options.suggestions?this._logger("WARNING: suggestions option is deprecated. Use suggest instead"):null,this._options.suggest&&(this._suggestIndex=new t(e({},this._options,{fields:this._options.suggest.fields||this._options.fields,storeFields:[],extractField:this._options.extractField,tokenize:this._options.tokenize,processTerm:this._options.processTerm}))),this}var r=t.prototype;return r.addFields=function(e){var t=this;e.forEach((function(e){t._index[e]||(t._index[e]={})}))},r.addAll=function(e){for(var t=0,r=e.length;t<r;t++)this.add(e[t]);return this},r.remove=function(e){var t=this._getDocumentId(e),r=this._getStoredFields(e);this._documentIds[t]=null;for(var n=0,i=this._fields;n<i.length;n++){var o=i[n],a=this._getFieldLength(e,o),s=this._fieldLengths[o];s[t]=null,this._avgFieldLength[o]=(this._avgFieldLength[o]*this._documentCount[o]-a)/(this._documentCount[o]-1),this._documentCount[o]--;var u=this._index[o];this._removeDocumentFromIndex(u,e,o)}this._suggestIndex&&this._suggestIndex.remove(e)},r.removeAll=function(e){var t=this;e.forEach((function(e){return t.remove(e)}))},r.add=function(e){var t=this._getDocumentId(e),r=this._getStoredFields(e);this._documentIds[t]=e;for(var n=0,i=this._fields;n<i.length;n++){var o=i[n],a=this._getFieldLength(e,o),s=this._fieldLengths[o];s[t]=a,this._avgFieldLength[o]=(this._avgFieldLength[o]*this._documentCount[o]+a)/(this._documentCount[o]+1),this._documentCount[o]++;var u=this._index[o];this._addDocumentToIndex(u,e,o)}this._suggestIndex&&this._suggestIndex.add(e)},r._getDocumentId=function(e){return e[this._idField]},r._getStoredFields=function(e){var t=this;return this._storeFields.reduce((function(r,n){return r[n]=e[n],r}),{})},r._getFieldLength=function(e,t){var r=this._options.extractField(e,t),n=this._options.tokenize(r,!0),i=this._options.processTerm;n=i?i(n):n;var o=Array.isArray(n)?n:n.split(/\s+/);return o.filter(Boolean).length},r._addDocumentToIndex=function(e,t,r){var n=this._options.extractField(t,r),i=this._options.tokenize(n,!0),o=this._options.processTerm;i=o?o(i):i;var a=Array.isArray(i)?i:i.split(/\s+/);a.filter(Boolean).forEach((function(t){e[t]||(e[t]=[]),e[t].push(t)}))},r._removeDocumentFromIndex=function(e,t,r){var n=this._options.extractField(t,r),i=this._options.tokenize(n,!0),o=this._options.processTerm;i=o?o(i):i;var a=Array.isArray(i)?i:i.split(/\s+/);a.filter(Boolean).forEach((function(t){var r=e[t];if(r){var n=r.indexOf(t);-1!==n&&r.splice(n,1),r.length||delete e[t]}}))},r.search=function(e,t){void 0===t&&(t={});var r=e,n=t.fields||this._fields,s=t.storeFields||this._storeFields,u=t.searchOptions||this._options.searchOptions,c=o(r,{tokenize:this._options.tokenize,processTerm:this._options.processTerm,fields:n,searchOptions:u}),l=a(c,{fields:n,storeFields:s,searchOptions:u}),f=this._bm25(l.queries,l.combine,l.boost,l.weights);return f.map((function(e){var t={score:e.score,id:e.id};return s.forEach((function(r,n){t[r]=e.store[n]})),t}))},r._bm25=function(e,t,r,n){var i=this,o=[],a=e.length,s=this._documentCount,u=this._avgFieldLength,c=this._fieldLengths,l=this._documentIds,f=this._storeFields,d=0;a>0&&(d=e[0].terms.length);for(var h=0;h<l.length;h++){if(null===l[h])continue;var p=1,g=0,v=l[h],y=c[h];if("AND"===t)for(var b=0;b<a;b++){var m=e[b],w=m.field,x=m.terms,_=0;if(x.forEach((function(e){var t=i._index[w][e.term];t&&t.includes(v)&&(_+=i._bm25Score(e.term,w,h,s[w],u[w],y[w],r,n))})),0===_)break;p*=Math.max(_,1)}else if("OR"===t){for(var b=0;b<a;b++){var m=e[b],w=m.field,x=m.terms,_=0;x.forEach((function(e){var t=i._index[w][e.term];t&&t.includes(v)&&(_+=i._bm25Score(e.term,w,h,s[w],u[w],y[w],r,n))})),g+=_}p=g}else throw new Error('Invalid combine option: "'+t+'". Valid options are "AND" and "OR"');p>0&&o.push({score:p,id:v,store:f.map((function(e){return l[h][e]}))})}return o.sort((function(e,t){return t.score-e.score}))},r._bm25Score=function(e,t,r,n,i,o,a,s){var u=this._index[t][e],c=u?u.length:0,l=Math.log((n-c+0.5)/(c+0.5)+1),f=1.2,d=0.75,h=o/(o+f*(1-d+d*(o/i)));return l*h},r.toJSON=function(){return{options:this._options,index:this._index,documentIds:this._documentIds,documentCount:this._documentCount,avgFieldLength:this._avgFieldLength,fieldLengths:this._fieldLengths}},t.loadJSON=function(r,n){var i=new t(n);return i._index=r.index,i._documentIds=r.documentIds,i._documentCount=r.documentCount,i._avgFieldLength=r.avgFieldLength,i._fieldLengths=r.fieldLengths,i},t.default=function(e){return e},t}();return s}));